---
title: "Projections on Human Cortex and Early Development datasets"
author: CAOBJr
date: '`r format(Sys.time(), "Last modified: %b %d %Y")`'
output: 
  rmdformats::downcute:
    fig_width: 25
    fig_height: 8
    thumbnails: true
    lightbox: true
    highlight: tango
editor_options: 
  chunk_output_type: console
---


```{r include = FALSE}
library(knitr)
opts_chunk$set(comment = NA, eval = TRUE)
```


## Preparing environment
```{r, eval = TRUE, message = FALSE, warning = FALSE}
library(Seurat)
library(tidyverse)
library(qs)
library(glue)

base_dir <- "/n/scratch/users/c/cao385/Ependymoma/dj83"
resources_dir <- glue('{base_dir}/helper_scripts')

source('/home/cao385/Projects/General-Codes/Resources/single_cell_preprocessing_helper_functions.R')
source('/home/cao385/Projects/General-Codes/Resources/NMF_helper_function.R')
source(glue('{resources_dir}/Plotting_helper_functions.R'))
source(glue('{resources_dir}/common_stat_test.R'))
source(glue('{resources_dir}/projection_helper_function.R'))

seurat_dir <- glue('{base_dir}/data/seurat_objects')
ZFTA_dir <- glue('{base_dir}/data/ZFTA_frozen')
fig_dir <- glue('{base_dir}/analysis/ST_all/Figures/Projections')
analysis_dir <- glue('{base_dir}/analysis/ST_all/')
ref_dir <- glue('{base_dir}/data/Normal_ref_data/Kriegstein_Human_Cortex')
```



## Projecting ZFTA-RELA frozen dataset
#### Retrieving markers in Nowakowski (2021) Early Development paper
```{r, eval = FALSE, message = FALSE, warning = FALSE}
ref_1 <- read.csv(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Nowakowski_2021_earlyDev_clusters.csv')) %>% 
  column_to_rownames('X')

ref_2 <- read.csv(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Nowakowski_2021_earlyDev_markers.csv'))

neuroepithelial_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Neuroepithelial'])
mesenchymal_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Mesenchymal'])
neuronal_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Neuronal'])
rg_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Radial Glial'])
ipc_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'IPC'])

markers_neuroepithelial <- ref_2 %>% filter(cluster %in% neuroepithelial_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_mesenchymal <- ref_2 %>% filter(cluster %in% mesenchymal_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_neuronal <- ref_2 %>% filter(cluster %in% neuronal_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_rg <- ref_2 %>% filter(cluster %in% rg_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_ipc <- ref_2 %>% filter(cluster %in% ipc_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(100, wt = avg_logFC) %>% pull(gene) %>% unique()

markers <- list(Neuroepithelial = markers_neuroepithelial, Mesenchymal = markers_mesenchymal, Neuronal = markers_neuronal, `Radial Glia` = markers_rg, IPC = markers_ipc)

qs::qsave(markers, glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/EarlyDev_markers.qs'))
```

#### Retrieving objects for Human Cortex reference
```{r, eval = TRUE, message = FALSE, warning = FALSE}
ref <- qread(glue('{ref_dir}/seurat objects/seurat_obj_hCortex_Kriegstein.qs'))

#ref$MergedCluster <- ref$WGCNAcluster
#RG_list <- c("oRG","tRG","vRG","RG-div1","RG-div2")
#IPC_list <- c("IPC-div1","IPC-div2","IPC-nEN1","IPC-nEN2","IPC-nEN3")
#NE_list <- c("nEN-early1","nEN-early2","nEN-late")
#ME_list <- c("EN-V1-1","EN-V1-2","EN-V1-3","EN-PFC1","EN-PFC2","EN-PFC3")
#MGE_list <- c("MGE-div","MGE-RG1","MGE-RG2","MGE-IPC1","MGE-IPC2","MGE-IPC3")
#nMGE_list <- c("nIN1","nIN2","nIN3","nIN4","nIN5")
#MGE_IN_list <- c("IN-CTX-MGE1","IN-CTX-MGE2")
#CGE_IN_list <- c("IN-CTX-CGE1","IN-CTX-CGE2")
#gene_list <- list(RG_list,IPC_list,NE_list,ME_list,MGE_list,nMGE_list,MGE_IN_list,CGE_IN_list)
#names(gene_list) <- c("Radial glia","IPCs","Newborn Excitatory Neurons","Maturing Excitatory Neurons","MGE Progenitors","Newborn MGE Neurons","MGE-derived Interneurons","CGE-derived Interneurons")
#clusters <- ref$MergedCluster
#for (i in 1:length(gene_list)) {
#  l <- gene_list[[i]]
#  for (j in l) {
#    clusters <- gsub(j,names(gene_list)[i],clusters)
#  }
#}
#ref$MergedCluster <- clusters
#qsave(ref,paste0(ref_dir,"seurat objects/seurat_obj_hCortex_Kriegstein.qs"))

Idents(ref) <- "MergedCluster"
ref_cm_1 <- AggregateExpression(ref)$RNA
colnames(ref_cm_1) <- gsub("RG-early", "Early Radial glia", colnames(ref_cm_1))

#DimPlot(ref, cols = clusterExperiment::bigPalette, group.by = 'MergedCluster')
Idents(ref) <- ref$MergedCluster
ref_degs_1 <- FindAllMarkers(ref, logfc.threshold = 0.5, only.pos = T) %>% filter(p_val_adj < 0.05)
ref_degs_1 <- ref_degs_1[!str_detect(ref_degs_1$gene, "RP11"), ]
ref_degs_1 <- ref_degs_1 %>% group_by(cluster) %>% arrange(-avg_log2FC, .by_group = T) %>% top_n(100, wt = avg_log2FC)
ref_degs_1 <- lapply(split(ref_degs_1, f = ref_degs_1$cluster), function(x) x$gene)
ref_degs_1 <- ref_degs_1[c("RG-early", "MGE Progenitors", "Newborn Excitatory Neurons", "Maturing Excitatory Neurons", "Newborn MGE Neurons", "MGE-derived Interneurons", "CGE-derived Interneurons", "Choroid", "Radial glia")]
#ref_degs_1 <- ref_degs_1[c("RG-early", "MGE Progenitors", "Newborn Excitatory Neurons", "Maturing Excitatory Neurons", "Newborn MGE Neurons", "MGE-derived Interneurons", "CGE-derived Interneurons", "Choroid", "Radial glia", "IPCs")]
names(ref_degs_1)[1] <- 'Early Radial glia'

## Reference Cortex
ref_hvgs_1 <- qread(file.path(ref_dir,"Projection RDS/hvgs/hvg_by_WGCNAcluster.qs"))
ref_degs_1 <- ref_degs_1[order(match(names(ref_degs_1), colnames(ref_cm_1)))]
```

#### Setting up both references
```{r, eval = TRUE, message = FALSE, warning = FALSE}
## Reference early development
ref_degs_2 <- qread(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/EarlyDev_markers.qs'))
ref_degs_2 <- ref_degs_2[c("Neuronal", "Radial Glia", "Neuroepithelial")]
ref_hvgs_2 <- qread(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/hvgs.qs'))
ref_cm_2 <- qread(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/agg_cm_mean.qs'))
colnames(ref_cm_2)[6] <- 'Radial Glia'
ref_degs_2 <- ref_degs_2[order(match(names(ref_degs_2),colnames(ref_cm_2)))]

## Merging commom programs between references
#genes_IPC <- unique(ref_degs_1$IPCs, ref_degs_2$IPC)
genes_RadialGlia <- unique(ref_degs_1$`Radial glia`, ref_degs_2$`Radial Glia`)

#names(ref_degs_1)[which(names(ref_degs_1) == 'IPCs')] <- 'IPC'
#ref_degs_1$IPC <- genes_IPC
names(ref_degs_1)[which(names(ref_degs_1) == 'Radial glia')] <- 'Radial Glia'
ref_degs_1$`Radial Glia` <- genes_RadialGlia
#colnames(ref_cm_1)[which(colnames(ref_cm_1) == 'IPCs')] <- 'IPC'
colnames(ref_cm_1)[which(colnames(ref_cm_1) == 'Radial glia')] <- 'Radial Glia'

#ref_degs_2$IPC <- genes_IPC
#names(ref_degs_2)[which(names(ref_degs_2) == 'Radial Glial')] <- 'Radial Glia'
ref_degs_2$`Radial Glia` <- genes_RadialGlia
#colnames(ref_cm_2)[which(colnames(ref_cm_2) == 'Radial Glial')] <- 'Radial Glia'
```

#### Running projection for Human Cortex dataset
```{r, eval = TRUE, message = FALSE, warning = FALSE}
data <- readRDS('/n/scratch/users/c/cao385/Ependymoma/seurat_obj_frozen_NPC_merged_clean.rds')

Idents(data) <- data$Metaprogram
pb_cm <- AggregateExpression(data)$RNA

pb_degs <- FindAllMarkers(data, logfc.threshold = 1, only.pos = T) %>% filter(p_val_adj < 0.05)
pb_degs <- pb_degs[!str_detect(pb_degs$gene, "RP11"), ]
pb_degs <- pb_degs %>% group_by(cluster) %>% arrange(-avg_log2FC, .by_group = T) %>% top_n(100, wt = avg_log2FC)
pb_degs <- lapply(split(pb_degs, f = pb_degs$cluster), function(x) x$gene)

pb_hvgs <- VariableFeatures(data)


# Filtering out genes with none expression
ref_cm_1 <- ref_cm_1[rowSums(ref_cm_1) > 1, names(ref_degs_1)]
pb_cm <- pb_cm[rowSums(pb_cm) > 0,]

## Signature genes
input_genes <- union(ref_hvgs_1, pb_hvgs)
input_genes <- intersect(input_genes, intersect(rownames(ref_cm_1), rownames(pb_cm)))

# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm_1)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean <- log2(rowMeans(ref_cm_1)+1)

## Tumor
pb_cm_norm <- log2(pb_cm+1)
pb_cm_mean <- log2(rowMeans(pb_cm)+1)
pb_cm_center <- t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)

# Score metagene programs in ref scRNA-seq data 
normal_score <- scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
normal_score <- t(normal_score)

tumor_score <- scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs_1)
#colnames(tumor_score) <- gsub("\\.","_",colnames(tumor_score))
tumor_score <- tumor_score[rownames(normal_score), colnames(normal_score)]

# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor <- calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
pairwise_cor <- pairwise_cor[rownames(normal_score), colnames(normal_score)]

## Prepare data
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp <- apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long <- melt(tmp)
colnames(normal_score_long) <- c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp <- apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long <- melt(tmp)
colnames(tumor_score_long) <- c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long <- melt(pairwise_cor)
colnames(pairwise_cor_long) <- c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score <- normal_score_long$score
pairwise_cor_long$tumor_score <- tumor_score_long$score

pairwise_cor_long[is.na(pairwise_cor_long)] <- 0

pairwise_cor_long2 <- pairwise_cor_long

tab_ref_1 <- pairwise_cor_long2
```

#### Running projection for Early development dataset
```{r, eval = TRUE, message = FALSE, warning = FALSE}
data <- readRDS('/n/scratch/users/c/cao385/Ependymoma/seurat_obj_frozen_NPC_merged_clean.rds')

Idents(data) <- data$Metaprogram
pb_cm <- AggregateExpression(data)$RNA

pb_degs <- FindAllMarkers(data, logfc.threshold = 1, only.pos = T) %>% filter(p_val_adj < 0.05)
pb_degs <- pb_degs[!str_detect(pb_degs$gene, "RP11"), ]
pb_degs <- pb_degs %>% group_by(cluster) %>% arrange(-avg_log2FC, .by_group = T) %>% top_n(100, wt = avg_log2FC)
pb_degs <- lapply(split(pb_degs, f = pb_degs$cluster), function(x) x$gene)

pb_hvgs <- VariableFeatures(data)


# Filtering out genes with none expression
ref_cm_2 <- ref_cm_2[rowSums(ref_cm_2) > 1, names(ref_degs_2)]
pb_cm <- pb_cm[rowSums(pb_cm) > 0,]

## Signature genes
input_genes = union(ref_hvgs_2, pb_hvgs)
input_genes = intersect(input_genes, intersect(rownames(ref_cm_2), rownames(pb_cm)))

# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm_2)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean = log2(rowMeans(ref_cm_2)+1)

## Tumor
pb_cm_norm <- log2(pb_cm+1)
pb_cm_mean <- log2(rowMeans(pb_cm)+1)
pb_cm_center <- t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)

# Score metagene programs in ref scRNA-seq data 
normal_score <- scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
normal_score <- t(normal_score)

tumor_score <- scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs_2)
tumor_score <- tumor_score[rownames(normal_score), colnames(normal_score)]

# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor <- calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
pairwise_cor <- pairwise_cor[rownames(normal_score), colnames(normal_score)]

## Prepare data
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp <- apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long <- melt(tmp)
colnames(normal_score_long) <- c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp <- apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long <- melt(tmp)
colnames(tumor_score_long) <- c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long <- melt(pairwise_cor)
colnames(pairwise_cor_long) <- c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score <- normal_score_long$score
pairwise_cor_long$tumor_score <- tumor_score_long$score

pairwise_cor_long[is.na(pairwise_cor_long)] <- 0

## Plot
tab_ref_2 <- pairwise_cor_long
```

#### DotPlot
```{r, eval = TRUE, message = FALSE, warning = FALSE, fig.width = 12, fig.height = 9}
tumor_programs_order <- rev(c('Cycling', 'Neuroepithelial-like', 'Radial glia-like', 'NPC-like', 'Ependymal-like', 'MES-like'))
programs_order <- c("Neuroepithelial", "Early Radial glia", "Radial Glia", "MGE Progenitors", "Newborn Excitatory Neurons", "Maturing Excitatory Neurons", "Newborn MGE Neurons", "MGE-derived Interneurons", "CGE-derived Interneurons", "Neuronal", "Choroid")

tab <- rbind(tab_ref_1 %>% mutate(ref = 'Cortex'), tab_ref_2 %>% mutate(ref = 'earlyDev'))

RG <- tab %>% 
  filter(Cell_type == 'Radial Glia') %>% 
  group_by(Subtype) %>% 
  mutate(r = mean(r), normal_score = mean(normal_score), tumor_score = mean(tumor_score)) %>%
  dplyr::select(-ref) %>% 
  unique() %>% 
  mutate(ref = 'intersection')

tab <- tab %>% filter(!Cell_type  %in% 'Radial Glia')
tab <- rbind(tab, RG)

p <- ggplot(tab, aes(x = factor(Subtype, tumor_programs_order), y = factor(Cell_type, programs_order))) +
  geom_point(aes(color = tumor_score, size = normal_score, alpha = r)) + 
  scale_size_area(max_size = 12) +
  scale_color_gradientn(colors = brewer.pal(n = 9, name = "Reds")) +
  labs(title = paste0("ZFTA-RELA Frozen"," "),
       x = "",
       y = "",
       color = "Expression score\n(tumor cells)", 
       size = "Expression score\n(normal cells)",
       alpha="Correlation Coefficient") +
  theme_bw() + 
  theme(plot.title = element_text(size=24, hjust = 0.5),
        axis.title = element_text(size=24),
        axis.text.x=element_text(size=20, hjust=1,angle=45),
        axis.text.y=element_text(size=20),
        legend.title = element_text(size=13),
        legend.text = element_text(size=13),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5, linetype = 'dashed', colour = "grey")) + 
  coord_flip()
#facet_wrap(~ref, scales = 'free_x') + ylab(NULL)
p <- p + theme(plot.margin = margin(10,10,10,40))
p

ggsave(plot = p, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ZFTA_RELA_Frozen_hCortex_earlyDev.png", width = 12, height = 9, dpi = 1200)
ggsave(plot = p, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ZFTA_RELA_Frozen_hCortex_earlyDev.pdf", width = 12, height = 9, dpi = 1200)
```





## Projecting EPN-ST-ALL dataset to cell types
#### Retrieving markers in Nowakowski (2021) Early Development paper
```{r, eval = FALSE, message = FALSE, warning = FALSE}
ref_1 <- read.csv(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Nowakowski_2021_earlyDev_clusters.csv')) %>% 
  column_to_rownames('X')

ref_2 <- read.csv(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Nowakowski_2021_earlyDev_markers.csv'))

neuroepithelial_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Neuroepithelial'])
mesenchymal_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Mesenchymal'])
neuronal_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Neuronal'])
rg_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'Radial Glial'])
ipc_clusters <- unique(ref_1$Cluster[ref_1$Cell.Type == 'IPC'])

markers_neuroepithelial <- ref_2 %>% filter(cluster %in% neuroepithelial_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_mesenchymal <- ref_2 %>% filter(cluster %in% mesenchymal_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_neuronal <- ref_2 %>% filter(cluster %in% neuronal_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_rg <- ref_2 %>% filter(cluster %in% rg_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(10, wt = avg_logFC) %>% pull(gene) %>% unique()
markers_ipc <- ref_2 %>% filter(cluster %in% ipc_clusters) %>% group_by(cluster) %>% arrange(-avg_logFC, .by_group = T) %>% top_n(100, wt = avg_logFC) %>% pull(gene) %>% unique()

markers <- list(Neuroepithelial = markers_neuroepithelial, Mesenchymal = markers_mesenchymal, Neuronal = markers_neuronal, `Radial Glia` = markers_rg, IPC = markers_ipc)

qs::qsave(markers, glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/EarlyDev_markers.qs'))
```

#### Retrieving objects for Human Cortex reference
```{r, eval = TRUE, message = FALSE, warning = FALSE}
ref <- qread(glue('{ref_dir}/seurat objects/seurat_obj_hCortex_Kriegstein.qs'))

#ref$MergedCluster <- ref$WGCNAcluster
#RG_list <- c("oRG","tRG","vRG","RG-div1","RG-div2")
#IPC_list <- c("IPC-div1","IPC-div2","IPC-nEN1","IPC-nEN2","IPC-nEN3")
#NE_list <- c("nEN-early1","nEN-early2","nEN-late")
#ME_list <- c("EN-V1-1","EN-V1-2","EN-V1-3","EN-PFC1","EN-PFC2","EN-PFC3")
#MGE_list <- c("MGE-div","MGE-RG1","MGE-RG2","MGE-IPC1","MGE-IPC2","MGE-IPC3")
#nMGE_list <- c("nIN1","nIN2","nIN3","nIN4","nIN5")
#MGE_IN_list <- c("IN-CTX-MGE1","IN-CTX-MGE2")
#CGE_IN_list <- c("IN-CTX-CGE1","IN-CTX-CGE2")
#gene_list <- list(RG_list,IPC_list,NE_list,ME_list,MGE_list,nMGE_list,MGE_IN_list,CGE_IN_list)
#names(gene_list) <- c("Radial glia","IPCs","Newborn Excitatory Neurons","Maturing Excitatory Neurons","MGE Progenitors","Newborn MGE Neurons","MGE-derived Interneurons","CGE-derived Interneurons")
#clusters <- ref$MergedCluster
#for (i in 1:length(gene_list)) {
#  l <- gene_list[[i]]
#  for (j in l) {
#    clusters <- gsub(j,names(gene_list)[i],clusters)
#  }
#}
#ref$MergedCluster <- clusters
#qsave(ref,paste0(ref_dir,"seurat objects/seurat_obj_hCortex_Kriegstein.qs"))

Idents(ref) <- "MergedCluster"
ref_cm_1 <- AggregateExpression(ref)$RNA
colnames(ref_cm_1) <- gsub("RG-early", "Early Radial glia", colnames(ref_cm_1))

#DimPlot(ref, cols = clusterExperiment::bigPalette, group.by = 'MergedCluster')
Idents(ref) <- ref$MergedCluster
ref_degs_1 <- FindAllMarkers(ref, logfc.threshold = 0.5, only.pos = T) %>% filter(p_val_adj < 0.05)
ref_degs_1 <- ref_degs_1[!str_detect(ref_degs_1$gene, "RP11"), ]
ref_degs_1 <- ref_degs_1 %>% group_by(cluster) %>% arrange(-avg_log2FC, .by_group = T) %>% top_n(100, wt = avg_log2FC)
ref_degs_1 <- lapply(split(ref_degs_1, f = ref_degs_1$cluster), function(x) x$gene)
ref_degs_1 <- ref_degs_1[c("RG-early", "MGE Progenitors", "Newborn Excitatory Neurons", "Maturing Excitatory Neurons", "Newborn MGE Neurons", "MGE-derived Interneurons", "CGE-derived Interneurons", "Choroid", "Radial glia")]
#ref_degs_1 <- ref_degs_1[c("RG-early", "MGE Progenitors", "Newborn Excitatory Neurons", "Maturing Excitatory Neurons", "Newborn MGE Neurons", "MGE-derived Interneurons", "CGE-derived Interneurons", "Choroid", "Radial glia", "IPCs")]
names(ref_degs_1)[1] <- 'Early Radial glia'

## Reference Cortex
ref_hvgs_1 <- qread(file.path(ref_dir,"Projection RDS/hvgs/hvg_by_WGCNAcluster.qs"))
ref_degs_1 <- ref_degs_1[order(match(names(ref_degs_1), colnames(ref_cm_1)))]
```

#### Setting up both references
```{r, eval = TRUE, message = FALSE, warning = FALSE}
## Reference early development
ref_degs_2 <- qread(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/EarlyDev_markers.qs'))
ref_degs_2 <- ref_degs_2[c("Neuronal", "Radial Glia", "Neuroepithelial")]
ref_hvgs_2 <- qread(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/hvgs.qs'))
ref_cm_2 <- qread(glue('{base_dir}/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/agg_cm_mean.qs'))
colnames(ref_cm_2)[6] <- 'Radial Glia'
ref_degs_2 <- ref_degs_2[order(match(names(ref_degs_2),colnames(ref_cm_2)))]

## Merging commom programs between references
#genes_IPC <- unique(ref_degs_1$IPCs, ref_degs_2$IPC)
genes_RadialGlia <- unique(ref_degs_1$`Radial glia`, ref_degs_2$`Radial Glia`)

#names(ref_degs_1)[which(names(ref_degs_1) == 'IPCs')] <- 'IPC'
#ref_degs_1$IPC <- genes_IPC
names(ref_degs_1)[which(names(ref_degs_1) == 'Radial glia')] <- 'Radial Glia'
ref_degs_1$`Radial Glia` <- genes_RadialGlia
#colnames(ref_cm_1)[which(colnames(ref_cm_1) == 'IPCs')] <- 'IPC'
colnames(ref_cm_1)[which(colnames(ref_cm_1) == 'Radial glia')] <- 'Radial Glia'

#ref_degs_2$IPC <- genes_IPC
#names(ref_degs_2)[which(names(ref_degs_2) == 'Radial Glial')] <- 'Radial Glia'
ref_degs_2$`Radial Glia` <- genes_RadialGlia
#colnames(ref_cm_2)[which(colnames(ref_cm_2) == 'Radial Glial')] <- 'Radial Glia'
```

#### Running projection for Human Cortex dataset
```{r, eval = TRUE, message = FALSE, warning = FALSE}
## Tumor
pb_degs <- qread(file.path(analysis_dir, "DEGs/ST_samples_DE_list.qs"))
pb_hvgs <- qread(file.path(analysis_dir, "Projection RDS/ST_hvgs.qs"))
pb_cm <- qread(file.path(analysis_dir, "Projection RDS/ST_samples_pseudobulk.qs"))

# Filtering out genes with none expression
ref_cm_1 <- ref_cm_1[rowSums(ref_cm_1) > 1, names(ref_degs_1)]
pb_cm <- pb_cm[rowSums(pb_cm) > 0,]

## Signature genes
input_genes <- union(ref_hvgs_1, pb_hvgs)
input_genes <- intersect(input_genes, intersect(rownames(ref_cm_1), rownames(pb_cm)))

# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm_1)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean <- log2(rowMeans(ref_cm_1)+1)

## Tumor
pb_cm_norm <- log2(pb_cm+1)
pb_cm_mean <- log2(rowMeans(pb_cm)+1)
pb_cm_center <- t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)

# Score metagene programs in ref scRNA-seq data 
normal_score <- scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
rownames(normal_score) <- gsub("\\.", "_", rownames(normal_score))
normal_score <- t(normal_score)

tumor_score <- scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs_1)
colnames(tumor_score) <- gsub("\\.","_",colnames(tumor_score))
tumor_score <- tumor_score[rownames(normal_score), colnames(normal_score)]

# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor <- calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
colnames(pairwise_cor) <- gsub("-","_",colnames(pairwise_cor))
pairwise_cor <- pairwise_cor[rownames(normal_score), colnames(normal_score)]

# Dotplot
## Prepare data
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp <- apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long <- melt(tmp)
colnames(normal_score_long) <- c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp <- apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long <- melt(tmp)
colnames(tumor_score_long) <- c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long <- melt(pairwise_cor)
colnames(pairwise_cor_long) <- c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score <- normal_score_long$score
pairwise_cor_long$tumor_score <- tumor_score_long$score

pairwise_cor_long[is.na(pairwise_cor_long)] <- 0

pairwise_cor_long2 <- pairwise_cor_long

tab_ref_1 <- pairwise_cor_long2
```

#### Running projection for Early development dataset
```{r, eval = TRUE, message = FALSE, warning = FALSE}
## Tumor
pb_degs <- qread(file.path(analysis_dir, "DEGs/ST_samples_DE_list.qs"))
pb_hvgs <- qread(file.path(analysis_dir, "Projection RDS/ST_hvgs.qs"))
pb_cm <- qread(file.path(analysis_dir, "Projection RDS/ST_samples_pseudobulk.qs"))

# Filtering out genes with none expression
ref_cm_2 <- ref_cm_2[rowSums(ref_cm_2) > 1, names(ref_degs_2)]
pb_cm <- pb_cm[rowSums(pb_cm) > 0,]

## Signature genes
input_genes = union(ref_hvgs_2, pb_hvgs)
input_genes = intersect(input_genes, intersect(rownames(ref_cm_2), rownames(pb_cm)))

# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm_2)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean = log2(rowMeans(ref_cm_2)+1)

## Tumor
pb_cm_norm <- log2(pb_cm+1)
pb_cm_mean <- log2(rowMeans(pb_cm)+1)
pb_cm_center <- t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)

# Score metagene programs in ref scRNA-seq data 
normal_score <- scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
normal_score <- t(normal_score)

tumor_score <- scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs_2)
colnames(tumor_score) <- gsub("-","_",colnames(tumor_score))
tumor_score <- tumor_score[rownames(normal_score), colnames(normal_score)]

# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor <- calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
colnames(pairwise_cor) <- gsub("-","_",colnames(pairwise_cor))
pairwise_cor <- pairwise_cor[rownames(normal_score), colnames(normal_score)]

# Dotplot
## Prepare data
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp <- apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long <- melt(tmp)
colnames(normal_score_long) <- c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp <- apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long <- melt(tmp)
colnames(tumor_score_long) <- c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long <- melt(pairwise_cor)
colnames(pairwise_cor_long) <- c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score <- normal_score_long$score
pairwise_cor_long$tumor_score <- tumor_score_long$score

pairwise_cor_long[is.na(pairwise_cor_long)] <- 0

## Plot
tab_ref_2 <- pairwise_cor_long
```

#### DotPlot
```{r, eval = TRUE, message = FALSE, warning = FALSE, fig.width = 9.5, fig.height = 20}
sample_order <- rev(c("3EP11","4EP49","3EP8","BT1743","4EP51","7EP35","7EP41","11EP22","3EP54","3EP67","7EP1","11EP8","7EP9","16EP8","4EP53","MUV43R1","MUV43R2","MUV43R4","WEPN9","4EP44","9EP47","9EP35","BT268","I128034","I128034R1","I128034R2","1230717","1599417","2192118","RD050618","RD141019","RD251119","4717EP17","FR0671","I050420","4EP46","9EP45","11EP21","3EP29"))
programs_order <- c("Neuroepithelial", "Early Radial glia", "Radial Glia", "MGE Progenitors", "Newborn Excitatory Neurons", "Maturing Excitatory Neurons", "Newborn MGE Neurons", "MGE-derived Interneurons", "CGE-derived Interneurons", "Neuronal", "Choroid")

tab <- rbind(tab_ref_1 %>% mutate(ref = 'Cortex'), tab_ref_2 %>% mutate(ref = 'earlyDev'))

RG <- tab %>% 
  filter(Cell_type == 'Radial Glia') %>% 
  group_by(Subtype) %>% 
  mutate(r = mean(r), normal_score = mean(normal_score), tumor_score = mean(tumor_score)) %>%
  dplyr::select(-ref) %>% 
  unique() %>% 
  mutate(ref = 'intersection')

#IPC <- tab %>% 
#  filter(Cell_type == 'IPC') %>% 
#  group_by(Subtype) %>% 
#  mutate(r = mean(r), normal_score = mean(normal_score), tumor_score = mean(tumor_score)) %>%
#  select(-ref) %>% 
#  unique() %>% 
#  mutate(ref = 'intersection')

#tab <- tab %>% filter(!Cell_type  %in% c('Radial Glia', 'IPC'))
#tab <- rbind(tab, RG, IPC)
tab <- tab %>% filter(!Cell_type  %in% 'Radial Glia')
tab <- rbind(tab, RG)

p <- ggplot(tab, aes(x = factor(Subtype, sample_order), y = factor(Cell_type, programs_order))) +
  geom_point(aes(color = tumor_score, size = normal_score, alpha = r)) + 
  scale_size_area(max_size = 12) +
  scale_color_gradientn(colors = brewer.pal(n = 9, name = "Reds")) +
  labs(title = paste0("ST-EPNs"," "),
       x = "",
       y = "",
       color = "Expression score\n(tumor cells)", 
       size = "Expression score\n(normal cells)",
       alpha="Correlation Coefficient") +
  theme_bw() + 
  theme(plot.title = element_text(size=24, hjust = 0.5),
        axis.title = element_text(size=24),
        axis.text.x=element_text(size=20, hjust=1,angle=45),
        axis.text.y=element_text(size=20),
        legend.title = element_text(size=13),
        legend.text = element_text(size=13),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5, linetype = 'dashed', colour = "grey")) + 
  coord_flip()
#facet_wrap(~ref, scales = 'free_x') + ylab(NULL)
p <- p + theme(plot.margin = margin(10,10,10,40)) + NoLegend()
p

ggsave("/n/scratch/users/c/cao385/Ependymoma/dj83/New/ST_all_hCortex_earlyDev.png", width = 9.5, height = 20, dpi = 1200)
```





## Projecting Early Development dataset by AgePCW (Sample)
```{r, eval = TRUE, message = FALSE, warning = FALSE, fig.width = 9.5, fig.height = 18}
ref <- readRDS('/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/seurat objects/seurat_obj_Nowakowski_earlyDev.rds')

ref$Age_PCW <- ref$Age
ref$Age_PCW <- gsub(12, 4, ref$Age_PCW)
ref$Age_PCW <- gsub(13, 4, ref$Age_PCW)
ref$Age_PCW <- gsub(14, 5, ref$Age_PCW)
ref$Age_PCW <- gsub(15, 6, ref$Age_PCW)
ref$Age_PCW <- gsub(19, 7, ref$Age_PCW)
ref$Age_PCW <- gsub(20, 8, ref$Age_PCW)
ref$Age_PCW <- gsub(22, 8, ref$Age_PCW)

## Reference
ref_degs <- readRDS("/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Projection RDS/ref_degs/ref_DE_genes_by_PCWAge_top50.rds")
ref_hvgs <- readRDS("/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Projection RDS/hvgs/hvg.rds")
ref_cm <- readRDS("/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Projection RDS/pseudobulk/pseudobulk_by_PCWAge.rds")
ref_degs <- ref_degs[order(match(names(ref_degs),colnames(ref_cm)))]

## Tumor
pb_degs <- qread(file.path(analysis_dir, "DEGs/ST_samples_DE_list.qs"))
pb_hvgs <- qread(file.path(analysis_dir, "Projection RDS/ST_hvgs.qs"))
pb_cm <- qread(file.path(analysis_dir, "Projection RDS/ST_samples_pseudobulk.qs"))

## Signature genes
input_genes = union(ref_hvgs, pb_hvgs)
input_genes = intersect(input_genes, intersect(rownames(ref_cm), rownames(pb_cm)))

# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean = log2(rowMeans(ref_cm)+1)

## Tumor
pb_cm_norm = log2(pb_cm+1)
pb_cm_mean = log2(rowMeans(pb_cm)+1)
pb_cm_center = t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)


# Score metagene programs in ref scRNA-seq data 
normal_score = scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
normal_score = t(normal_score)

tumor_score = scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs)
colnames(tumor_score) = gsub("-","_",colnames(tumor_score))
tumor_score = tumor_score[rownames(normal_score), colnames(normal_score)]


# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor = calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
colnames(pairwise_cor) = gsub("-","_",colnames(pairwise_cor))
pairwise_cor = pairwise_cor[rownames(normal_score), colnames(normal_score)]
##saveRDS(pairwise_cor, file=paste0(analysis_dir, ref_df, "_pairwise_cor.rds"))


# Dotplot
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp = apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long = melt(tmp)
colnames(normal_score_long) = c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp = apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long = melt(tmp)
colnames(tumor_score_long) = c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long = melt(pairwise_cor)
colnames(pairwise_cor_long) = c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score = normal_score_long$score
pairwise_cor_long$tumor_score = tumor_score_long$score

pairwise_cor_long[is.na(pairwise_cor_long)] = 0

## Plot
pairwise_cor_long2 <- pairwise_cor_long

ref_order_trimmed = c("PCW4", "PCW5", "PCW6", "PCW7", "PCW8")

sample_order <- rev(c("3EP11","4EP49","3EP8","BT1743","4EP51","7EP35","7EP41","11EP22","3EP54","3EP67","7EP1","11EP8","7EP9","16EP8","4EP53","MUV43R1","MUV43R2","MUV43R4","WEPN9","4EP44","9EP47","9EP35","BT268","I128034","I128034R1","I128034R2","1230717","1599417","2192118","RD050618","RD141019","RD251119","4717EP17","FR0671","I050420","4EP46","9EP45","11EP21","3EP29"))

p <- ggplot(pairwise_cor_long2, aes(x=factor(Subtype,sample_order), y=factor(Cell_type,ref_order_trimmed))) +
  geom_point(aes(color=tumor_score,size=normal_score,alpha=r)) + scale_size_area(max_size=12) +
  scale_color_gradientn(colors=brewer.pal(n=9, name="Reds")) +
  labs(title = paste0("ST-EPNs"," "),
       x = "",
       y = "",
       color = "Expression score\n(tumor cells)", 
       size = "Expression score\n(normal cells)",
       alpha="Correlation Coefficient") +
  theme_classic() + 
  theme(plot.title = element_text(size=24, hjust = 0.5),
        axis.title = element_text(size=24),
        axis.text.x=element_text(size=20, hjust=1,angle=45),
        axis.text.y=element_text(size=20),
        legend.title = element_text(size=13),
        legend.text = element_text(size=13),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5, linetype = 'dashed', colour = "grey"))+coord_flip()
p <- p + theme(plot.margin = margin(10,10,10,40))
ggsave(plot = p, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ST_all_hCortex_earlyDev_AgePCW_Sample.png", width = 8, height = 17, dpi = 1200)
ggsave(plot = p, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ST_all_hCortex_earlyDev_AgePCW_Sample.pdf", width = 8, height = 17, dpi = 1200)
```





## Projecting Early Development dataset by AgePCW (Programs)
```{r, eval = TRUE, message = FALSE, warning = FALSE, fig.width = 9.5, fig.height = 18}
ref <- readRDS('/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/seurat objects/seurat_obj_Nowakowski_earlyDev.rds')

ref$Age_PCW <- ref$Age
ref$Age_PCW <- gsub(12, 4, ref$Age_PCW)
ref$Age_PCW <- gsub(13, 4, ref$Age_PCW)
ref$Age_PCW <- gsub(14, 5, ref$Age_PCW)
ref$Age_PCW <- gsub(15, 6, ref$Age_PCW)
ref$Age_PCW <- gsub(19, 7, ref$Age_PCW)
ref$Age_PCW <- gsub(20, 8, ref$Age_PCW)
ref$Age_PCW <- gsub(22, 8, ref$Age_PCW)

## Reference
ref_degs <- readRDS("/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Projection RDS/ref_degs/ref_DE_genes_by_PCWAge_top50.rds")
ref_hvgs <- readRDS("/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Projection RDS/hvgs/hvg.rds")
ref_cm <- readRDS("/n/scratch/users/c/cao385/Ependymoma/dj83/data/Normal_ref_data/Nowakowski_earlydev_natureneuro2021/Projection RDS/pseudobulk/pseudobulk_by_PCWAge.rds")
ref_degs <- ref_degs[order(match(names(ref_degs),colnames(ref_cm)))]


## Tumor
data <- readRDS('/n/scratch/users/c/cao385/Ependymoma/seurat_obj_frozen_NPC_merged_clean.rds')

Idents(data) <- data$Metaprogram
pb_cm <- AggregateExpression(data)$RNA

pb_degs <- FindAllMarkers(data, logfc.threshold = 1, only.pos = T) %>% filter(p_val_adj < 0.05)
pb_degs <- pb_degs[!str_detect(pb_degs$gene, "RP11"), ]
pb_degs <- pb_degs %>% group_by(cluster) %>% arrange(-avg_log2FC, .by_group = T) %>% top_n(100, wt = avg_log2FC)
pb_degs <- lapply(split(pb_degs, f = pb_degs$cluster), function(x) x$gene)

pb_hvgs <- VariableFeatures(data)


## Signature genes
input_genes = union(ref_hvgs, pb_hvgs)
input_genes = intersect(input_genes, intersect(rownames(ref_cm), rownames(pb_cm)))

# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean = log2(rowMeans(ref_cm)+1)

## Tumor
pb_cm_norm = log2(pb_cm+1)
pb_cm_mean = log2(rowMeans(pb_cm)+1)
pb_cm_center = t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)


# Score metagene programs in ref scRNA-seq data 
normal_score = scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
normal_score = t(normal_score)

tumor_score = scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs)
#colnames(tumor_score) = gsub("-","_",colnames(tumor_score))
tumor_score = tumor_score[rownames(normal_score), colnames(normal_score)]


# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor = calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
#colnames(pairwise_cor) = gsub("-","_",colnames(pairwise_cor))
pairwise_cor = pairwise_cor[rownames(normal_score), colnames(normal_score)]
##saveRDS(pairwise_cor, file=paste0(analysis_dir, ref_df, "_pairwise_cor.rds"))


# Dotplot
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp = apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long = melt(tmp)
colnames(normal_score_long) = c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp = apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long = melt(tmp)
colnames(tumor_score_long) = c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long = melt(pairwise_cor)
colnames(pairwise_cor_long) = c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score = normal_score_long$score
pairwise_cor_long$tumor_score = tumor_score_long$score

pairwise_cor_long[is.na(pairwise_cor_long)] = 0

## Plot
pairwise_cor_long2 <- pairwise_cor_long

ref_order_trimmed = c("PCW4", "PCW5", "PCW6", "PCW7", "PCW8")

#sample_order <- rev(c("3EP11","4EP49","3EP8","BT1743","4EP51","7EP35","7EP41","11EP22","3EP54","3EP67","7EP1","11EP8","7EP9","16EP8","4EP53","MUV43R1","MUV43R2","MUV43R4","WEPN9","4EP44","9EP47","9EP35","BT268","I128034","I128034R1","I128034R2","1230717","1599417","2192118","RD050618","RD141019","RD251119","4717EP17","FR0671","I050420","4EP46","9EP45","11EP21","3EP29"))

pairwise_cor_long2$Subtype <- factor(as.character(pairwise_cor_long2$Subtype), levels = rev(levels(pairwise_cor_long2$Subtype)))
p <- ggplot(pairwise_cor_long2, aes(x = Subtype, y = factor(Cell_type, ref_order_trimmed))) +
  geom_point(aes(color=tumor_score,size=normal_score,alpha=r)) + scale_size_area(max_size=12) +
  scale_color_gradientn(colors=brewer.pal(n=9, name="Reds")) +
  labs(title = paste0("ST-EPNs"," "),
       x = "",
       y = "",
       color = "Expression score\n(tumor cells)", 
       size = "Expression score\n(normal cells)",
       alpha="Correlation Coefficient") +
  theme_classic() + 
  theme(plot.title = element_text(size=24, hjust = 0.5),
        axis.title = element_text(size=24),
        axis.text.x=element_text(size=20, hjust=1,angle=45),
        axis.text.y=element_text(size=20),
        legend.title = element_text(size=13),
        legend.text = element_text(size=13),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5, linetype = 'dashed', colour = "grey"))+coord_flip()
p <- p + theme(plot.margin = margin(10,10,10,40))
ggsave(plot = p, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ST_all_hCortex_earlyDev_AgePCW_Programs.png", width = 9.5, height = 8, dpi = 1200)
ggsave(plot = p, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ST_all_hCortex_earlyDev_AgePCW_Programs.pdf", width = 9.5, height = 8, dpi = 1200)
```





## Projecting Linnarsson dataset (aiming neural-crest program)
#### Getting markers per programs
```{r, eval = FALSE, message = FALSE, warning = FALSE}
data <- qread('/n/scratch/users/c/cao385/Linnarsson_2022/seurat.qs')
DimPlot(data, reduction = "umap.full", group.by = 'CellClass', cols = clusterExperiment::bigPalette, alpha = 0.1)

## DEGs
Idents(data) <- data$CellClass
markers <- RunPrestoAll(data, only.pos = T, logfc.threshold = 0.5) %>%
  filter(p_val_adj < 0.05) %>%
  group_by(cluster) %>%
  arrange(-avg_log2FC, .by_group = T)
qsave(markers, "/n/scratch/users/c/cao385/Linnarsson_2022/markers_CellClass.qs")
```

#### Generating dotplot
```{r, eval = TRUE, message = FALSE, warning = FALSE, fig.width = 9.5, fig.height = 18}
## Reference
ref_degs <- qread("/n/scratch/users/c/cao385/Linnarsson_2022/markers_CellClass.qs")
ref_degs <- ref_degs %>% group_by(cluster) %>% top_n(50, wt = avg_log2FC)
ref_degs <- lapply(split(ref_degs, f = ref_degs$cluster), function(x) x$gene)
ref_hvgs <- qread("/n/scratch/users/c/cao385/Linnarsson_2022/hvgs.qs")
ref_cm <- qread("/n/scratch/users/c/cao385/Linnarsson_2022/agg_cm_mean_CellClass.qs")
ref_degs <- ref_degs[order(match(names(ref_degs),colnames(ref_cm)))]


## Tumor
pb_degs <- qread(file.path(analysis_dir, "DEGs/ST_samples_DE_list.qs"))
pb_hvgs <- qread(file.path(analysis_dir, "Projection RDS/ST_hvgs.qs"))
pb_cm <- qread(file.path(analysis_dir, "Projection RDS/ST_samples_pseudobulk.qs"))


## Signature genes
input_genes = union(ref_hvgs, pb_hvgs)
input_genes = intersect(input_genes, intersect(rownames(ref_cm), rownames(pb_cm)))


# Normalize data
## Ref
ref_cm_list <- NormCenter(ref_cm)
ref_cm_norm <- ref_cm_list$norm_data
ref_cm_center <- ref_cm_list$center_data
ref_cm_mean = log2(rowMeans(ref_cm)+1)

## Tumor
pb_cm_norm = log2(pb_cm+1)
pb_cm_mean = log2(rowMeans(pb_cm)+1)
pb_cm_center = t(scale(t(pb_cm_norm)))
pb_cm_norm <- as.matrix(pb_cm_norm)


# Score metagene programs in ref scRNA-seq data 
normal_score = scoreNmfGenes(ref_cm_center, ref_cm_mean, pb_degs)
normal_score = t(normal_score)

tumor_score = scoreNmfGenes(pb_cm_center, pb_cm_mean, ref_degs)
colnames(tumor_score) = gsub("-","_",colnames(tumor_score))
tumor_score = tumor_score[rownames(normal_score), colnames(normal_score)]


# Pairwise correlation between ref and epn aggregated cm 
pairwise_cor = calculatePairwiseCor(ref_cm_norm, pb_cm_norm, input_genes)
colnames(pairwise_cor) = gsub("-","_",colnames(pairwise_cor))
pairwise_cor = pairwise_cor[rownames(normal_score), colnames(normal_score)]
##saveRDS(pairwise_cor, file=paste0(analysis_dir, ref_df, "_pairwise_cor.rds"))


# Dotplot
## Prepare data
## max-min normalization and melt scoring normal cells by malignant metaprogram
tmp = apply(normal_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
normal_score_long = melt(tmp)
colnames(normal_score_long) = c("Cell_type", "Subtype", "score")

## max-min normalization and melt scoring tumor cells by normal DEGs
tmp = apply(tumor_score, 2, function(x) (x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T)))
tumor_score_long = melt(tmp)
colnames(tumor_score_long) = c("Cell_type", "Subtype", "score")

## Melt pairwise correlation 
pairwise_cor_long = melt(pairwise_cor)
colnames(pairwise_cor_long) = c("Cell_type", "Subtype", "r")

## Add score to pairwise-cor
pairwise_cor_long$normal_score = normal_score_long$score
pairwise_cor_long$tumor_score = tumor_score_long$score

## Replace "_" with "-"
#pairwise_cor_long$Cell_type = gsub("_", "-", pairwise_cor_long$Cell_type)
#pairwise_cor_long$Metaprogram = gsub("_", "-", pairwise_cor_long$Metaprogram)

pairwise_cor_long[is.na(pairwise_cor_long)] = 0


## Plot
pairwise_cor_long2 <- pairwise_cor_long

ref_order_trimmed <- unique(pairwise_cor_long2$Cell_type)

sample_order <- rev(c("3EP11","4EP49","3EP8","BT1743","4EP51","7EP35","7EP41","11EP22","3EP54","3EP67","7EP1","11EP8","7EP9","16EP8","4EP53","MUV43R1","MUV43R2","MUV43R4","WEPN9","4EP44","9EP47","9EP35","BT268","I128034","I128034R1","I128034R2","1230717","1599417","2192118","RD050618","RD141019","RD251119","4717EP17","FR0671","I050420","4EP46","9EP45","11EP21","3EP29"))


pt2 = ggplot(pairwise_cor_long2, aes(x=factor(Subtype,sample_order), y=factor(Cell_type,ref_order_trimmed))) +
  geom_point(aes(color=tumor_score,size=normal_score,alpha=r)) + scale_size_area(max_size=12) +
  scale_color_gradientn(colors=brewer.pal(n=9, name="Reds")) +
  labs(title = paste0("ST-EPNs"," "),
       x = "",
       y = "",
       color = "Expression score\n(tumor cells)", 
       size = "Expression score\n(normal cells)",
       alpha="Correlation Coefficient") +
  theme_classic() + 
  theme(plot.title = element_text(size=24, hjust = 0.5),
        axis.title = element_text(size=24),
        axis.text.x=element_text(size=20, hjust=1,angle=45),
        axis.text.y=element_text(size=20),
        legend.title = element_text(size=13),
        legend.text = element_text(size=13),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5, linetype = 'dashed', colour = "grey"))+coord_flip()
pt2 <- pt2 + theme(plot.margin = margin(10,10,10,40))
pt2
ggsave(plot = pt2, "/n/scratch/users/c/cao385/Ependymoma/dj83/New/ST_samples_Linnarsson_Crest.png", width = 9.5, height = 18, dpi = 1200)
```



## Session information
```{r session, eval = TRUE}
sessionInfo()
```